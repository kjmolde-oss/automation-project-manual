# File: cluster-setup.yml (Final Version for Kubeadm)
---
- name: ‚öôÔ∏è 1. Prepare All Nodes for Kubernetes Installation (Prerequisites)
  hosts: kube_master, kube_workers
  become: yes
  gather_facts: yes
  tasks:
    - name: Ensure kernel modules and sysctl params are set
      ansible.builtin.shell: |
        # Load kernel modules (Note: Requires prior collection installation via bitbucket-pipelines.yml)
        modprobe overlay
        modprobe br_netfilter
        # Enable IP forwarding for bridge traffic (Kubernetes requirement)
        sysctl net.bridge.bridge-nf-call-iptables=1
      args:
        executable: /bin/bash

    - name: Install Container Runtime (Docker)
      ansible.builtin.apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker is running
      ansible.builtin.systemd_service:
        name: docker
        state: started
        enabled: yes

    - name: Disable Swap (Kubernetes Requirement)
      ansible.builtin.shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
      register: swap_status
      changed_when: swap_status.stdout != ""
      tags: swap

- name: üöÄ 2. Install Kubeadm Tools on All Nodes
  hosts: kube_master, kube_workers
  become: yes
  tasks:
    # --- FIX: ADD KUBERNETES APT REPOSITORY ---
    - name: Add Kubernetes APT key
      ansible.builtin.shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | \
        gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        executable: /bin/bash

    - name: Add Kubernetes repository to sources list
      ansible.builtin.apt_repository:
        repo: 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /'
        state: present
        filename: kubernetes
        update_cache: yes # Force APT cache update after adding repo

    # --- FINAL INSTALLATION ---
    - name: Install Kubeadm, Kubelet, and Kubectl (Now packages are available)
      ansible.builtin.apt:
        name: 
          - kubelet
          - kubeadm
          - kubectl
        state: present
        # This holds the packages at the current version to prevent accidental auto-upgrades
        allow_downgrade: yes 
        dpkg_options: 'force-confdef,force-confold'

- name: üè∑Ô∏è 3. Label Worker Node for App Scheduling
  hosts: kube_workers
  become: no # Run kubectl as the user that owns the kubeconfig
  gather_facts: false
  tasks:
    - name: Label Worker Node with 'node-type=app-worker'
      ansible.builtin.shell: |
        # Executes the label command remotely. Assumes kubeconfig is sourced correctly.
        kubectl label node {{ inventory_hostname }} node-type=app-worker --overwrite
      register: label_output
      changed_when: "'labeled' in label_output.stdout"

- name: ‚úÖ 4. Final Verification
  hosts: kube_master, kube_workers
  gather_facts: false
  tasks:
    - name: Test SSH connection post-setup
      ansible.builtin.ping: