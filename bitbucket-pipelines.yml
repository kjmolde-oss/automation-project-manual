pipelines:
  branches:
    dev:
      - step:
          name: ðŸ—ï¸ Build and Push Docker Image to GHCR
          services:
            - docker
          runs-on:
            - self.hosted
            - linux
          script:
            # 1. Set Image Details for GHCR
            - export IMAGE_NAME="ghcr.io/${GH_USER}/automation-project" # Use GHCR format
            - export VERSION="prod-0.1.${BITBUCKET_BUILD_NUMBER}"
            - export VERSIONED_IMAGE="${IMAGE_NAME}:${VERSION}"
            
            # 2. Login to GitHub Container Registry
            - echo "$GH_TOKEN" | docker login ghcr.io -u "$GH_USER" --password-stdin
            
            # 3. Build, Tag, and Push
            - echo "Building and pushing ${VERSIONED_IMAGE}..."
            - docker build -t "${IMAGE_NAME}:latest" .
            - docker tag "${IMAGE_NAME}:latest" "${VERSIONED_IMAGE}"
            - docker push "${IMAGE_NAME}:latest"
            - docker push "${VERSIONED_IMAGE}"
            - echo "âœ… Image pushed successfully to GHCR!"
            
            # 4. Create the artifact for the next step
            - echo "${VERSIONED_IMAGE}" > image_name.txt
          artifacts:
            - image_name.txt

      - step:
          name: ðŸš€ Deploy to Kubernetes
          runs-on:
            - self.hosted
            - linux
          deployment: Production
          script:
            # 1. Read the image name from the previous step's artifact
            - export VERSIONED_IMAGE=$(cat image_name.txt)
            - export K8S_MANIFEST_PATH="k8s/deployment.yaml"

            # 2. Update the Kubernetes Manifest
            # Make sure yq is installed on your runner's image or install it here.
            - echo "Updating manifest with image"
            - yq e ".spec.template.spec.containers[0].image = \"${VERSIONED_IMAGE}\"" -i "${K8S_MANIFEST_PATH}"

            # 3. Apply the Manifest
            # The runner uses its in-cluster service account for authentication. No SSH needed.
            - kubectl apply -f "${K8S_MANIFEST_PATH}"

            # 4. Verify the Rollout
            - kubectl rollout status deployment/automation-project-deployment
            - echo "âœ… Deployment successful!"