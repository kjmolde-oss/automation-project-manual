pipelines:
  branches:
    dev:
      - step:
          name: ðŸ—ï¸ Build and Push Docker Image
          runs-on:
            - self.hosted
            - linux.shell
          script:
            # CI Step: Build and push the versioned image
            - export DOCKER_HOST=unix:///var/run/docker.sock
            # ... (Docker login, build, push commands remain the same) ...
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - IMAGE_NAME="${DOCKERHUB_USERNAME}/automation-project"
            - VERSION="prod-0.1.${BITBUCKET_BUILD_NUMBER}"
            - VERSIONED_IMAGE="${IMAGE_NAME}:${VERSION}"
            - docker build --no-cache -t "${IMAGE_NAME}:latest" .
            - docker tag "${IMAGE_NAME}:latest" "${VERSIONED_IMAGE}"
            - docker push "${IMAGE_NAME}:latest"
            - docker push "${VERSIONED_IMAGE}"
            - echo "Image pushed successfully!"

      - step:
          name: ðŸš€ Deploy via Ansible to LXD Target
          runs-on:
            - self.hosted
            - linux.shell
          deployment: Production
          script:
            # 1. Install necessary Python and Ansible tools
            - apt-get update && apt-get install -y python3-pip openssh-client
            - pip install ansible # This now works because python3-pip is installed
            
            # 2. Configure SSH Key for Ansible
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" | sed 's/\r$//' > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            
            # 3. Add Host Fingerprint (Using the stable container IP)
            - ssh-keyscan -H 10.81.37.50 >> ~/.ssh/known_hosts

            # 4. Execute Ansible Playbook
            - echo "Executing Ansible playbook for remote deployment..."
            - ansible-playbook -i inventory.ini deploy.yml \
              --private-key ~/.ssh/id_rsa \
              --extra-vars "target_host=ansible_target_node"

            - rm ~/.ssh/id_rsa
            - echo "âœ… Deployment via Ansible completed successfully!"