pipelines:
  branches:
    dev:
      - step:
          name: ðŸ—ï¸ Build and Push Docker Image
          runs-on:
            - self.hosted
            - linux.shell
          script:
            # CI: Build and push the versioned image
            - export DOCKER_HOST=unix:///var/run/docker.sock
            - echo "Logging in to Docker Hub..."
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            - IMAGE_NAME="${DOCKERHUB_USERNAME}/automation-project"
            - VERSION="prod-0.1.${BITBUCKET_BUILD_NUMBER}"
            - VERSIONED_IMAGE="${IMAGE_NAME}:${VERSION}"
            - echo "Building Docker image..."
            - docker build -t "${IMAGE_NAME}:latest" .
            - docker tag "${IMAGE_NAME}:latest" "${VERSIONED_IMAGE}"
            - echo "Pushing images..."
            - docker push "${IMAGE_NAME}:latest"
            - docker push "${VERSIONED_IMAGE}"
            - echo "Image pushed successfully!"

      - step:
          name: ðŸš€ Deploy App to K8s and Ansible Targets
          runs-on:
            - self.hosted
            - linux.shell
          deployment: Production
          script:
            # --- INITIAL SETUP & SSH AGENT MANAGEMENT ---
            - export CLONE_DIR="${BITBUCKET_CLONE_DIR}" 
            - export K8S_MANIFEST_PATH="k8s/deployment.yaml"
            - export TARGET_HOST="192.168.1.33"
            - export DEPLOY_USER="deploy"
            - cd "${CLONE_DIR}"
            
            # 1. Install prerequisites (Ansible and SSH client)
            - sudo apt-get update && sudo apt-get install -y ansible openssh-client
            
            # 2. Configure SSH Key
            - mkdir -p ~/.ssh
            - echo "$SSH_PRIVATE_KEY" | sed 's/\r$//' > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            
            # 3. START/USE SSH AGENT AND ADD KEY (The Professional Fix)
            # This loads the key, resolving the "agent refused operation" error.
            - eval "$(ssh-agent -s)" 
            - ssh-add ~/.ssh/id_rsa   
            
            # 4. Add Host Fingerprint
            - ssh-keyscan -H $TARGET_HOST >> ~/.ssh/known_hosts

            # --- KUBERNETES DEPLOYMENT ---
            - echo "--- Starting K8s Deployment ---"
            # ... (K8s deployment logic) ...
            
            # --- ANSIBLE DEPLOYMENT ---
            - echo "--- Starting Ansible Deployment to Worker Node ---"
            
            # EXECUTE ANSIBLE PLAYBOOK (No need for --private-key as the agent is used)
            - ansible-playbook -i inventory.ini deploy.yml --user "$DEPLOY_USER"
            
            # 5. Clean up agent and key file
            - ssh-add -D # Deletes all identities from the agent
            - rm ~/.ssh/id_rsa
            - echo "âœ… Hybrid Deployment successful!"