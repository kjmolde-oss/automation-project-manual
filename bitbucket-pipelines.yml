pipelines:
  branches:
    dev:
      - step:
          name: ðŸ—ï¸ Build and Push Docker Image
          runs-on:
            - self.hosted
            - linux.shell
          script:
            # --- Ensure Docker is available ---
            - echo "ðŸ” Checking Docker availability..."
            - unset DOCKER_HOST || true
            - docker info || (echo "âŒ Docker daemon not reachable. Ensure /var/run/docker.sock is mounted to the runner." && exit 1)

            # --- 1. Set Image Details ---
            - export IMAGE_NAME="${DOCKERHUB_USERNAME}/automation-project"
            - export VERSION="prod-0.1.${BITBUCKET_BUILD_NUMBER}"
            - export VERSIONED_IMAGE="${IMAGE_NAME}:${VERSION}"

            # --- 2. Login to Docker Hub ---
            - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

            # --- 3. Build, Tag, and Push ---
            - echo "ðŸš€ Building and pushing ${VERSIONED_IMAGE}..."
            - docker build -t "${IMAGE_NAME}:latest" .
            - docker tag "${IMAGE_NAME}:latest" "${VERSIONED_IMAGE}"
            - docker push "${IMAGE_NAME}:latest"
            - docker push "${VERSIONED_IMAGE}"
            - echo "âœ… Image pushed successfully!"

            # --- 4. Create the artifact for the next step ---
            - echo "${VERSIONED_IMAGE}" > image_name.txt

          # Only store the needed artifact
          artifacts:
            - image_name.txt

      - step:
          name: ðŸš€ Deploy to Kubernetes
          runs-on:
            - self.hosted
            - linux.shell
          deployment: Production
          script:
            # --- 1. Read the image name from the artifact ---
            - export VERSIONED_IMAGE=$(cat image_name.txt)
            - export K8S_MANIFEST_PATH="k8s/deployment.yaml"
            - export K8S_SERVICE_PATH="k8s/service.yaml"

            # --- 2. Update the Kubernetes Manifest ---
            - echo "ðŸ“¦ Updating Kubernetes manifest with ${VERSIONED_IMAGE}"
            - yq e ".spec.template.spec.containers[0].image = \"${VERSIONED_IMAGE}\"" -i "${K8S_MANIFEST_PATH}"

            # --- 3. Apply the Manifest ---
            - kubectl apply -f "${K8S_MANIFEST_PATH}"
            - kubectl apply -f "${K8S_SERVICE_PATH}"

            # --- 4. Verify the Rollout ---
            - kubectl rollout status deployment/automation-project-deployment
            - echo "âœ… Deployment successful!"

